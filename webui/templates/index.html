<!DOCTYPE html>
<html>
<head>
    <title>Google Sheets Viewer —Å –ò–ò</title>
    <link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9;
            margin: 40px;
        }

        h2, h3 {
            color: #333;
        }

        #sheetTable_wrapper {
            margin-bottom: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #questionForm {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #questionForm input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        #questionForm button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.2s;
        }

        #questionForm button:hover {
            background-color: #0056b3;
        }

        #answer {
            background-color: #fff;
            border-left: 4px solid #007bff;
            padding: 15px;
            min-height: 60px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            font-size: 16px;
            color: #333;
        }

        /* –°–¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–µ–º–Ω–æ–≥–æ –∫—Ä–∞—Å–∏–≤–µ–µ */
        table.dataTable thead {
            background-color: #007bff;
            color: white;
        }

        table.dataTable tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table.dataTable tbody tr:hover {
            background-color: #e1f0ff;
        }
    </style>
</head>
<body>
    <h2>üìä –¢–∞–±–ª–∏—Ü–∞ –∏–∑ Google Sheets</h2>
    <table id="sheetTable" class="display"></table>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
    <h3>‚ùì –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ–± —ç—Ç–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö:</h3>
    <form id="questionForm">
        <input type="text" id="question" name="question" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...">
        <button type="submit">–°–ø—Ä–æ—Å–∏—Ç—å</button>
        <button type="button" id="askStreamBtn">–°–ø—Ä–æ—Å–∏—Ç—å 2 (—Å—Ç—Ä–∏–º)</button>
    </form>

    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ -->
    <h3>üí¨ –û—Ç–≤–µ—Ç –ò–ò:</h3>
    <div id="answer"></div>

    <script>
        const sheetId = "1XLYtLDKuWEEls5baZ-w6iCptWa3subEnyoV1suo5jog";

        fetch(`/sheet/${sheetId}`)
            .then(res => res.json())
            .then(data => {
                const values = data.values;
                const columns = values[0].map(col => ({title: col}));
                const rows = values.slice(1);

                $('#sheetTable').DataTable({
                    data: rows,
                    columns: columns
                });
            });

        $("#questionForm").on("submit", async function(e) {
            e.preventDefault();
            const question = $("#question").val().trim();
            if (!question) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!");

            const answerDiv = $("#answer");
            answerDiv.text("‚è≥ –î—É–º–∞—é...");

            const response = await fetch("/ask", {
                method: "POST",
                body: new URLSearchParams({ question })
            });

            const data = await response.json();
            answerDiv.text(data.answer || "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞");
        });

        $("#askStreamBtn").on("click", async function() {
            const question = $("#question").val().trim();
            if (!question) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!");

            const answerDiv = $("#answer");
            answerDiv.text("‚è≥ –î—É–º–∞—é...\n");

            const response = await fetch("/ask_stream", {
                method: "POST",
                body: new URLSearchParams({ question })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            answerDiv.text(""); // –æ—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Å—Ç—Ä–∏–º–æ–º

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                answerDiv.text(answerDiv.text() + chunk);
            }
        });
    </script>
</body>
</html>
